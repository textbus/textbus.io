<h1>协同文档</h1>
<p><strong style="color:rgb(231, 79, 94)">注意：目前为测试版，不要用于生产环境</strong></p>
<p>Textbus 坚定的支持在线协同文档，官方已通过&nbsp;<a target="_blank" href="https://github.com/yjs/yjs">Yjs</a>&nbsp;实现了在线协作编辑。</p>
<h2>安装依赖</h2>
<p>我们以 yjs 提供的 webrtc 作为本地示例，在实际的生产环境中，你需要根据自己的需求，选择合适的通讯方式，更多细节，请参考关于 Yjs 的文档。</p><pre lang=""><div style="width:2em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">npm install @textbus/collaborate y-webrtc</div></div></pre>
<h2>配置协同依赖</h2>
<p>我们先准备一个 DOM 容器，放置多用户的信息。</p><pre lang="HTML"><div style="width:2em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">user-info</span>"&gt;&lt;/<span class="tb-hl-tag">div</span>&gt;</div></div><span class="tb-pre-lang">HTML</span></pre>
<p>配置协同相关服务。</p><pre lang="TypeScript"><div style="width:2em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ createEditor }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/editor'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ RootComponentRef }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Collaborate, CollaborateCursor, CollaborateHistory, RemoteSelection }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/collaborate'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ WebrtcProvider }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'y-webrtc'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;header = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'user-info'</span>)!</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">User</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">}</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-function">createEditor</span>(document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'editor'</span>)!, {</div><div class="tb-code-line">&nbsp;&nbsp;theme:&nbsp;<span class="tb-hl-string">'light'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;placeholder:&nbsp;<span class="tb-hl-string">'请输入内容……'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;providers: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;Collaborate,&nbsp;<span class="tb-hl-comment">// 协同支持核心类</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;CollaborateCursor,&nbsp;<code><span class="tb-hl-comment">// 协同多光标实现类</span></code></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide: History,&nbsp;<code><span class="tb-hl-comment">// 替换内核历史记录管理类为协同历史记录管理类</span></code></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;useClass: Collaborate</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>(starter) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 获取协同核心库实例</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;collaborate = starter.<span class="tb-hl-function">get</span>(Collaborate)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 开启房间</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;provide =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">WebrtcProvider</span>(<span class="tb-hl-string">'textbus'</span>, collaborate.yDoc)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 模拟多用户</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;users: User[] = [{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#f00'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'张三'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#448299'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'李国'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#fe91dd'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'赵功'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#1f2baf'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'载膛'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#2aad30'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'魂牵梦萦'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#c4ee6e'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'杰国'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#00a6ff'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'膛世界杯'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}]</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 随机取一个用户</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;user = users[Math.<span class="tb-hl-function">floor</span>(Math.<span class="tb-hl-function">random</span>() * users.length)]</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 设置当前用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'user'</span>, user)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 启用协同</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;collaborate.<span class="tb-hl-function">setup</span>()</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 监听本地用户选区变化，并同步</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;collaborate.onSelectionChange.<span class="tb-hl-function">subscribe</span>(paths =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;localSelection: RemoteSelection = {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username: user.name,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color: user.color,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paths</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'selection'</span>, localSelection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 监听远端数据变化</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">on</span>(<span class="tb-hl-string">'update'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;users: User[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;remoteSelections: RemoteSelection[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">getStates</span>().<span class="tb-hl-function">forEach</span>(state =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.user) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users.<span class="tb-hl-function">push</span>(state.user)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.selection) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remoteSelections.<span class="tb-hl-function">push</span>(state.selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 过滤本地用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selections = remoteSelections.<span class="tb-hl-function">filter</span>(i =&gt; i.username !== user.name)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 绘制远端用户选区</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collaborate.<span class="tb-hl-function">updateRemoteSelection</span>(selections)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 更新用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header.innerHTML = users.<span class="tb-hl-function">map</span>(i =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;<span class="tb-hl-string">`&lt;span style="color:&nbsp;</span>${i.color}<span class="tb-hl-string">"&gt;</span>${i.name}<span class="tb-hl-string">&lt;/span&gt;`</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).<span class="tb-hl-function">join</span>(<span class="tb-hl-string">''</span>)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></pre>
<p>现在在本地浏览器开启两个窗口体验一下协作编辑吧！</p>
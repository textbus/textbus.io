<h1>协同文档</h1>
<p>Textbus 坚定的支持在线协同文档，官方已通过&nbsp;<a target="_blank" href="https://github.com/yjs/yjs">Yjs</a>&nbsp;实现了在线协作编辑。</p>
<h2>本地协作</h2>
<p>我们以 yjs 提供的 webrtc 作为本地示例。</p><pre lang="" theme="null" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">npm install @textbus/collaborate y-webrtc</div></div><span class="tb-pre-lang"></span></pre>
<h3>配置协同依赖</h3>
<p>我们先准备一个 DOM 容器，放置多用户的信息。</p><pre lang="HTML" theme="null" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">user-info</span>"&gt;&lt;/<span class="tb-hl-tag">div</span>&gt;</div></div><span class="tb-pre-lang">HTML</span></pre>
<p>配置协同相关服务。</p><pre lang="TypeScript" theme="null" class="tb-pre"><div style="width:3em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ createEditor, TableComponentSelectionAwarenessDelegate }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/editor'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Collaborate, collaborateModule }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/collaborate'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{&nbsp;</div><div class="tb-code-line">&nbsp;&nbsp;CollaborateSelectionAwarenessDelegate,</div><div class="tb-code-line">&nbsp;&nbsp;RemoteSelection,</div><div class="tb-code-line">&nbsp;&nbsp;CollaborateCursor</div><div class="tb-code-line">}&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/platform-browser'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Selection }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ WebrtcProvider }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'y-webrtc'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;header = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'user-info'</span>)!</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">User</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">}</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-function">createEditor</span>({</div><div class="tb-code-line">&nbsp;&nbsp;theme:&nbsp;<span class="tb-hl-string">'light'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;placeholder:&nbsp;<span class="tb-hl-string">'请输入内容……'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;imports: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;collaborateModule&nbsp;<span class="tb-hl-comment">// 添加协作模块</span></div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;providers: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide: CollaborateSelectionAwarenessDelegate,&nbsp;<span class="tb-hl-comment">// 提供表格框选协作选区特效支持</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;useClass: TableComponentSelectionAwarenessDelegate</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>(starter) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selection = starter.<span class="tb-hl-function">get</span>(Selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;collaborateCursor = injector.<span class="tb-hl-function">get</span>(CollaborateCursor)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 开启房间</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;provide =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">WebrtcProvider</span>(<span class="tb-hl-string">'textbus'</span>, collaborate.yDoc)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 模拟多用户</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;users: User[] = [{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#f00'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'张三'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#448299'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'李国'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#fe91dd'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'赵功'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#1f2baf'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'载膛'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#2aad30'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'魂牵梦萦'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#c4ee6e'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'杰国'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-string">'#00a6ff'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'膛世界杯'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}]</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 随机取一个用户</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;user = users[Math.<span class="tb-hl-function">floor</span>(Math.<span class="tb-hl-function">random</span>() * users.length)]</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 设置当前用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'user'</span>, user)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 监听本地用户选区变化，并同步</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;subscription = selection.onChange.<span class="tb-hl-function">subscribe</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cosnt paths = selection.<span class="tb-hl-function">getPaths</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;localSelection: RemoteSelection = {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username: user.name,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color: user.color,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paths</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'selection'</span>, localSelection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 监听远端数据变化</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">on</span>(<span class="tb-hl-string">'update'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;users: User[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;remoteSelections: RemoteSelection[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">getStates</span>().<span class="tb-hl-function">forEach</span>(state =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.user) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users.<span class="tb-hl-function">push</span>(state.user)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.selection) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remoteSelections.<span class="tb-hl-function">push</span>(state.selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 过滤本地用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selections = remoteSelections.<span class="tb-hl-function">filter</span>(i =&gt; i.username !== user.name)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 绘制远端用户选区</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collaborateCursor.<span class="tb-hl-function">draw</span>(selections)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 更新用户信息</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header.innerHTML = users.<span class="tb-hl-function">map</span>(i =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;<span class="tb-hl-string">`&lt;span style="color:&nbsp;</span>${i.color}<span class="tb-hl-string">"&gt;</span>${i.name}<span class="tb-hl-string">&lt;/span&gt;`</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).<span class="tb-hl-function">join</span>(<span class="tb-hl-string">''</span>)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 编辑器销毁时，取消连接</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.<span class="tb-hl-function">disconnect</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subscription.<span class="tb-hl-function">unsubscribe</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">})</div><div class="tb-code-line"><br></div><div class="tb-code-line">editor.<span class="tb-hl-function">mount</span>(document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'editor'</span>)!)</div></div><span class="tb-pre-lang">TypeScript</span></pre>
<p>现在在本地浏览器开启两个窗口体验一下协作编辑吧！</p>
<h2>基于 WebSocket 的协作</h2>
<p>上面的示例只适用于在没有服务端的情况下在本地开启协作，真正的协作需要我们本地连接到服务器。关于 y-websocket 的相关问题，请查阅&nbsp;<a target="_blank" href="https://docs.yjs.dev/ecosystem/connection-provider/y-websocket">Yjs</a>&nbsp;官网。</p><pre lang="" theme="null" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">npm install @textbus/collaborate y-websocket</div></div><span class="tb-pre-lang"></span></pre>
<p>配置协作服务</p><pre lang="TypeScript" theme="null" class="tb-pre"><div style="width:3em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ createEditor, TableComponentSelectionAwarenessDelegate }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/editor'</span>;</div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{&nbsp;</div><div class="tb-code-line">&nbsp;&nbsp;CollaborateSelectionAwarenessDelegate,</div><div class="tb-code-line">&nbsp;&nbsp;RemoteSelection,</div><div class="tb-code-line">&nbsp;&nbsp;CollaborateCursor</div><div class="tb-code-line">}&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/platform-browser'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Selection }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ WebsocketProvider }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'y-websocket'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;Axios&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'axios'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">CollabContext</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;username:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;id:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;roomname:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">}</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">User</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;color:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">}</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-function">createEditor</span>({</div><div class="tb-code-line">&nbsp;&nbsp;autoFocus:&nbsp;<span class="tb-hl-boolean">true</span>,</div><div class="tb-code-line">&nbsp;&nbsp;zenCoding:&nbsp;<span class="tb-hl-boolean">true</span>,</div><div class="tb-code-line">&nbsp;&nbsp;historyStackSize:&nbsp;<span class="tb-hl-number">30</span>,</div><div class="tb-code-line">&nbsp;&nbsp;placeholder:&nbsp;<span class="tb-hl-string">'欢迎你体验 Textbus 在线协同开发版...'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;imports: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;collaborateModule</div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;providers: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide: CollaborateSelectionAwarenessDelegate,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;useClass: TableComponentSelectionAwarenessDelegate</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">async</span>&nbsp;<span class="tb-hl-function">setup</span>(injector) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selection = starter.<span class="tb-hl-function">get</span>(Selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;collaborateCursor = injector.<span class="tb-hl-function">get</span>(CollaborateCursor)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 从服务器获取协作上下文</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;context: CollabContext =&nbsp;<span class="tb-hl-keyword">await</span>&nbsp;Axios.<span class="tb-hl-function">get</span>(<span class="tb-hl-string">'/api/collab-context'</span>)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 连接当前协作文档到服务端指定的房间</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;provide =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">WebsocketProvider</span>(<span class="tb-hl-string">'wss://api/collab'</span>, context.roomname, collaborate.yDoc)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 设置当前用户</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;user: User = {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: context.username,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color: context.color,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id: context.id</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'user'</span>, user)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 同步当前用户选区到远程，其它用户可以看到当前用户的选区</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;subscription = selection.onChange.<span class="tb-hl-function">subscribe</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;paths = selection.<span class="tb-hl-function">getPaths</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;localSelection: RemoteSelection = {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username: context.username,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color: context.color,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paths,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id: context.id</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">setLocalStateField</span>(<span class="tb-hl-string">'selection'</span>, localSelection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 获取远程用户及选区</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">on</span>(<span class="tb-hl-string">'update'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;users: User[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;remoteSelections: RemoteSelection[] = []</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.awareness.<span class="tb-hl-function">getStates</span>().<span class="tb-hl-function">forEach</span>(state =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.user) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users.<span class="tb-hl-function">push</span>(state.user)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(state.selection) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remoteSelections.<span class="tb-hl-function">push</span>(state.selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 过滤当前用户，当前用户不需要显示协作选区</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selections = remoteSelections.<span class="tb-hl-function">filter</span>(i =&gt; i.id !== user.id)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collaborateCursor.<span class="tb-hl-function">draw</span>(selections)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-builtin">console</span>.<span class="tb-hl-function">log</span>(<span class="tb-hl-string">'当前上线用户'</span>, users)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 等待协作文档加载完成</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-builtin">Promise</span>&lt;()<span class="tb-hl-class-name">&nbsp;</span>=&gt;&nbsp;<span class="tb-hl-keyword">void</span>&gt;((resolve) =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.<span class="tb-hl-function">on</span>(<span class="tb-hl-string">'sync'</span>, (<span class="tb-hl-keyword">is</span>:&nbsp;<span class="tb-hl-builtin">boolean</span>) =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(<span class="tb-hl-keyword">is</span>) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">resolve</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 当编辑器销毁时，关闭远程连接并取消订阅</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;provide.<span class="tb-hl-function">disconnect</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subscription.<span class="tb-hl-function">unsubscribe</span>()</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div><div class="tb-code-line"><br></div><div class="tb-code-line">editor.<span class="tb-hl-function">mount</span>(document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'editor'</span>)).<span class="tb-hl-function">then</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-builtin">console</span>.<span class="tb-hl-function">log</span>(<span class="tb-hl-string">'协作编辑器创建成功！'</span>)</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></pre>
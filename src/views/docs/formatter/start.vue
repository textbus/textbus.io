<script setup lang="ts">
import { useDocUpdate } from '@/hooks/use-doc-update';
import { ref } from 'vue';

const doc = ref<HTMLElement>()
useDocUpdate(doc)
</script>
<template>
  <div ref="doc">
    <h1>格式</h1>
<p>什么是格式？</p>
<p>在 TextBus 中，格式是指对插槽内容起修饰作用的样式或属性，和组件不同的是，格式可以任意指定它在插槽内的作用范围。如加粗、斜体、字体颜色或对齐方式等。需要注意的是，格式不一定是 CSS 样式，也可以自定义的标签，也可以是 className。例如 a 标签，也是一种格式，在 @textbus/editor 包内，a 标签叫做 linkFormatter，它不仅渲染为 a 标签，还会渲染 href 和 target 属性。&nbsp;</p>
<p>和组件不同的是，我们只能指定格式渲染为标签或是属性和生效范围。格式的渲染嵌套是由 TextBus 自动完成的，且不能像组件一样，定义一个复杂的模板。</p>
<p>总之，你要想灵活的设置一段内容的样式或属性，那么就从格式入手吧。我们以字体大小为例：</p><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;fontSizeFormatter = {</span><span class="tb-code-line">&nbsp;&nbsp;type: FormatType.Attribute,</span><span class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'FontSizeFormatter'</span>,</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">render</span>(element, formatValue) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 如果没有节点，我们就创建一个节点并设计样式</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;element = element ||&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">VElement</span>(<span class="tb-hl-string">'span'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;element.styles.<span class="tb-hl-function">set</span>(<span class="tb-hl-string">'fontSize'</span>, formatValue)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;element</span><span class="tb-code-line">&nbsp;&nbsp;}</span><span class="tb-code-line">}</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<h2>格式选项</h2>
<p>在上面的示例中，我们可以看到一个格式和一些配置项，下面我们来看看这些配置项都有哪些作用。</p>
<h3>type</h3>
<p>格式类型。格式有三种类型：</p>
<ul>
  <li>块级格式：FormatType.Block</li>
  <li>行内标签格式：FormatType.InlineTag</li>
  <li>属性格式：FormatType.Attribute</li>
</ul>
<p>在开发格式时，需要注意类型的定义，它会影响到渲染的优先级。TextBus 总是先渲染标签，再渲染属性，以保证能生成最简洁的 DOM 结构。</p>
<h3>name</h3>
<p>格式的名字，需要注意的是，在一个编辑器实例中，格式的名字必须是唯一的。</p>
<h3>render()</h3>
<p>渲染方法。自定义格式渲染的结果。你可以创建一个新的标签。或者在已有节点上添加你自己的属性（如果有的话）。格式只能是一个标签或在一个标签上添加属性。不能有自定义的嵌套结构。</p>
<p>render 方法在调用时，会传入三个参数，它们分别是：</p>
<ol>
  <li>element：和当前格式相同范围的已渲染节点。有可能没有，则你需要自己生成一个节点。</li>
  <li>formatValue：当前格式设置的值。它可以是任意值。根据格式的不同而不同。如 fontSizeFormatter，它的值可能是&nbsp;<code>'​12px'</code>&nbsp;这样的字符串；boldFormatter，它的值可能是&nbsp;<code>true</code>&nbsp;或者&nbsp;<code>false</code>。</li>
  <li>isOutputMode：是否是输出模式。在某些场景中，我们需要编辑时和最终结果有一些差异。你可以以此作为条件。</li>
</ol>
<h2>格式加载器</h2>
<p>和组件一样，格式也需要能够识别 DOM 节点。</p><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;fontSizeFormatLoader = {</span><span class="tb-code-line">&nbsp;&nbsp;formatter: fontSizeFormatter,</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 匹配一个节点是否为格式节点</span></span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">match</span>(element) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;!!element.style.fontSize</span><span class="tb-code-line">&nbsp;&nbsp;},</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 读取格式的值</span></span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">read</span>(element) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;element.style.fontSize</span><span class="tb-code-line">&nbsp;&nbsp;}</span><span class="tb-code-line">}</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<h3>formatter</h3>
<p>格式加载器绑定的格式。</p>
<h3>match()</h3>
<p>用于匹配一个节点是否为一个格式节点。返回 boolean 值。</p>
<h3>read()</h3>
<p>当 match 方法返回值为 true 时，则会调用 read 方法获取格式的值并返回。</p>
<h2>应用格式</h2>
<p>现在，我们可以把我们创建好的格式添加到编辑器中了。</p><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Editor }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/editor'</span></span><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ fontSizeFormatLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./font-size-formatter'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Editor</span>(<span class="tb-hl-string">'#editor'</span>, {</span><span class="tb-code-line">&nbsp;&nbsp;formatLoaders: [</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;fontSizeFormatLoader</span><span class="tb-code-line">&nbsp;&nbsp;]</span><span class="tb-code-line">})</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<p>至此，我们的编辑器就可以支持文字大小的功能了。</p>
<h3>动态设置格式</h3>
<p>等等，我们虽然添加了 fontSizeFormatter，但并没有一个工具去触发，让它在编辑器内动态添加上去。让我们在页面添加一个按钮，当用户点击的时候，就让编辑器内的文字加粗。</p><pre lang="HTML"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line">&lt;<span class="tb-hl-tag">p&nbsp;</span><span class="tb-hl-attr-name">class</span>="<span class="tb-hl-attr-value">toolbar</span>"&gt;</span><span class="tb-code-line">&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">font-size-btn</span>"&gt;设置为 12px&lt;/<span class="tb-hl-tag">button</span>&gt;</span><span class="tb-code-line">&lt;/<span class="tb-hl-tag">p</span>&gt;</span><span class="tb-code-line">&lt;<span class="tb-hl-tag">p&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">editor</span>"&gt;&lt;/<span class="tb-hl-tag">p</span>&gt;</span></span><span class="tb-pre-lang">HTML</span></pre><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Commander }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></span><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ fontSizeFormatLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./font-size-formatter'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;btn = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'font-size-btn'</span>)</span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-comment">// 当编辑器准备好时，我们再添加功能</span></span><span class="tb-code-line">editor.onReady.<span class="tb-hl-function">subscribe</span>(() =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;injector = editor.injector</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander = injector.<span class="tb-hl-function">get</span>(Commander)</span><span class="tb-code-line">&nbsp;&nbsp;btn.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">applyFormat</span>(fontSizeFormatLoader,&nbsp;<span class="tb-hl-string">'12px'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;})</span><span class="tb-code-line">})</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<p>现在，我们框选一段文字并点击设置按钮时，你就会看到文字已经添加了 fontSize=12px 的样式了，如果，光标是闭合的，TextBus 也会智能的让后面输入的文字生效。</p>
<p>在实际的应用中，仅仅设置是不满足需求的，我们更希望如果已经生效了，则取消效果。这时，则需要状态查询来帮助我们完成相应的功能。让我们继续完善上面的功能。</p><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Commander, Query, QueryStateType }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></span><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ fontSizeFormatLoader, fontSizeFormatter }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./font-size-formatter'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;btn = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'font-size-btn'</span>)</span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-comment">// 当编辑器准备好时，我们再添加功能</span></span><span class="tb-code-line">editor.onReady.<span class="tb-hl-function">subscribe</span>(() =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;injector = editor.injector</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander = injector.<span class="tb-hl-function">get</span>(Commander)</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;query = injector.<span class="tb-hl-function">get</span>(Query)</span><span class="tb-code-line">&nbsp;&nbsp;btn.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 通过 Query，查询当前光标所在范围是否已生效</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;queryState = query.<span class="tb-hl-function">queryFormat</span>(fontSizeFormatter)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;isValid = queryState.state === QueryStateType.Enabled &amp;&amp; queryState.value ===&nbsp;<span class="tb-hl-string">'12px'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 如果已生效，我们则取消效果，否则就再次应用</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(isValid) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">unApplyFormat</span>(fontSizeFormatter)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="tb-hl-keyword">else</span>&nbsp;{</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">applyFormat</span>(fontSizeFormatter,&nbsp;<span class="tb-hl-string">'12px'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="tb-code-line">&nbsp;&nbsp;})</span><span class="tb-code-line">})</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<h3>工具高亮</h3>
<p>现在我们可以根据查询状态，分别设置应用或取消应用样式了，我们还需要实时监听编辑器内容的变化，让按钮呈现高亮的效果，给用户更好的反馈。<br></p><pre lang="TypeScript"><span style="width:2em" class="tb-code-line-number-bg"></span><span class="tb-code-content"><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Commander, Query, QueryStateType, Renderer }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></span><span class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ fontSizeFormatLoader, fontSizeFormatter }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./font-size-formatter'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;btn = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'font-size-btn'</span>)</span><span class="tb-code-line"><br></span><span class="tb-code-line"><span class="tb-hl-comment">// 当编辑器准备好时，我们再添加功能</span></span><span class="tb-code-line">editor.onReady.<span class="tb-hl-function">subscribe</span>(() =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;injector = editor.injector</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander = injector.<span class="tb-hl-function">get</span>(Commander)</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;query = injector.<span class="tb-hl-function">get</span>(Query)</span><span class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;renderer = injector.<span class="tb-hl-function">get</span>(Renderer)</span><span class="tb-code-line"><br></span><span class="tb-code-line">&nbsp;&nbsp;renderer.onViewChecked.<span class="tb-hl-function">subscribe</span>(() =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;queryState = query.<span class="tb-hl-function">queryFormat</span>(fontSizeFormatter)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;isValid = queryState.state === QueryStateType.Enabled &amp;&amp; queryState.value ===&nbsp;<span class="tb-hl-string">'12px'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 根据编辑器实时状态，高亮显示按钮</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(isValid) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;btn.classList.<span class="tb-hl-function">add</span>(<span class="tb-hl-string">'active'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="tb-hl-keyword">else</span>&nbsp;{</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;btn.classList.<span class="tb-hl-function">remove</span>(<span class="tb-hl-string">'active'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="tb-code-line">&nbsp;&nbsp;})</span><span class="tb-code-line"><br></span><span class="tb-code-line">&nbsp;&nbsp;btn.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 通过 Query，查询当前光标所在范围是否已生效</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;queryState = query.<span class="tb-hl-function">queryFormat</span>(fontSizeFormatter)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;isValid = queryState.state === QueryStateType.Enabled &amp;&amp; queryState.value ===&nbsp;<span class="tb-hl-string">'12px'</span></span><span class="tb-code-line"><br></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 如果已生效，我们则取消效果，否则就再次应用</span></span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(isValid) {</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">unApplyFormat</span>(fontSizeFormatter)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="tb-hl-keyword">else</span>&nbsp;{</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">applyFormat</span>(fontSizeFormatter,&nbsp;<span class="tb-hl-string">'12px'</span>)</span><span class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="tb-code-line">&nbsp;&nbsp;})</span><span class="tb-code-line">})</span></span><span class="tb-pre-lang">TypeScript</span></pre>
<p>至此，我们的文本大小工具，就基本完成了。</p>
  </div>
</template>
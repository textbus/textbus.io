<script setup lang="ts">
import { useDocUpdate } from '@/hooks/use-doc-update';
import { ref } from 'vue';

const doc = ref<HTMLElement>()
useDocUpdate(doc)
</script>
<template>
  <div ref="doc">
    <h1>引言</h1>
<p style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">你也许已经使用过 Vue 或者 React 这样的前端框架，你是否惊叹于这些前端框架带给你革命性的开发体验？</p>
<p style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">如果答案为是的话，那么你将在 Textbus 里获得同样的感受。是的，当你看到 Textbus 的组件扩展时，你会发现，这和前端框架太像了。你可以通过 defineComponent 函数定义一个组件，用 JSX 编辑写组件的 render 函数，简直再熟悉不过了。这在以前是不敢想象的。现在，你唾手可得。</p>
<p>从本节开始，你将真正踏入 Textbus 开发的门槛，整个深入的文档，可能需要你花费一个小时来阅读，相信你一定会有所收获。在阅读时，你可以不用太过注重细节，等遇到问题时，再来重新查阅。</p>
<p>在进入具体文档之前，我们先来认识 Textbus 的基础模块：</p>
<ul>
  <li class="tb-list-item"><span style="color:rgb(18, 150, 219)"><strong>Core&nbsp;</strong></span>核心模块 @textbus/core<br>Textbus 内核模块，定义了数据结构、渲染器、选区、事件及数据操作的一系列抽象和封装。</li>
  <li class="tb-list-item"><span style="color:rgb(18, 150, 219)"><strong>Browser&nbsp;</strong></span>浏览器模块 @textbus/browser<br>Textbus pc 端浏览器支持层，提供了 Textbus 在 pc 端浏览器运行的中间层。</li>
  <li class="tb-list-item"><span style="color:rgb(18, 150, 219)"><strong>Collaborate&nbsp;</strong></span>协作模块 @textbus/collaborate<br>Textbus 多人在线实时协作支持库，让 Textbus 支持多人在线编辑，并同步多用户光标和选区等功能。</li>
  <li class="tb-list-item"><span style="color:rgb(18, 150, 219)"><strong>Editor&nbsp;</strong></span>编辑器 @textbus/editor<br>Textbus 官方提供的所见即所得的富文本编辑器，开发了常见富文本编辑器的基础功能。</li>
</ul>
<p>接下来，我们将以 Core 和 Browser 模块为基础，逐步开发我们自己的编辑器。</p>
<p><br></p>
<h1>准备</h1>
<p>安装依赖：</p><pre lang="" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">npm install @textbus/core @textbus/browser</div></div><span class="tb-pre-lang"></span></pre>
<h2 style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">TSX/JSX 配置</h2>
<p style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">在 Textbus 中，我们可以使用 jsx / tsx 编写 Textbus 组件，前提是你需要配置相应环境才可以正确编译。我们以 ts 的开发环境为例，在项目中的 tsconfig.json 中添加如下声明：</p><pre lang="JSON" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">{</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-attr-name">"compilerOptions"</span>: {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-attr-name">"jsx"</span>:&nbsp;<span class="tb-hl-string">"react"</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-attr-name">"jsxFactory"</span>:&nbsp;<span class="tb-hl-string">"VElement.createElement"</span></div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">JSON</span></pre>
<p style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">以上配置适用于在整个项目只有一种 tsx 类型的情况，如果在 Vue/React 项目中，以上声明会导致 Textbus 的虚拟 DOM 工厂函数和 Vue/React 的虚拟 DOM 工厂函数发生冲突。同时，Vue cli 的 ts 项目的编译方式和 React 项目的编辑方式还有所不同，我们需要分别处理。</p>
<p style="background-color:rgb(255, 255, 255);color:rgb(73, 80, 96)">如果你不想使用 TypeScript，而是用 JavaScript &nbsp;开发，你还可以用 babel 来转换 jsx，babel 自定义 jsx 工厂函数的方法，请使用搜索引擎或 babel 官网查看相关文档。</p>
<ul>
  <li style="background-color:rgb(255, 255, 255)" class="tb-list-item"><span style="color:rgb(73, 80, 96)"><strong>React 项目配置</strong></span><br><span style="color:rgb(73, 80, 96)">本仓库演示了在 React 项目内，同时使用两种 jsx 工厂函数的项目配置，仅作为参考。<a target="_blank" href="https://github.com/textbus/react-demo">https://github.com/textbus/react-demo</a></span></li>
  <li style="background-color:rgb(255, 255, 255)" class="tb-list-item"><span style="color:rgb(73, 80, 96)"><strong>Vue 项目配置</strong></span><br><span style="color:rgb(73, 80, 96)">本仓库演示了在 Vue 项目内，同时使用两种 jsx 工厂函数的项目配置，仅作为参考。<a target="_blank" href="https://github.com/textbus/vue-demo">https://github.com/textbus/vue-demo</a></span></li>
</ul>
<p>接下来我们实例化编辑器</p><pre lang="HTML" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">editor</span>"&gt;&lt;/<span class="tb-hl-tag">div</span>&gt;</div></div><span class="tb-pre-lang">HTML</span></pre><pre lang="TypeScript" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Viewer }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/browser'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 获取编辑器容器</span></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editorBox = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'editor'</span>)</div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Viewer</span>(根组件, 根组件加载器)</div></div><span class="tb-pre-lang">TypeScript</span></pre>
<p>Textbus 默念不包含任何组件，当我们要实例化编辑器时，发现必须要传递两个参数，我们需要先准备好根组件和根组件加载器。</p>
<h2>根组件及加载器</h2>
<p>新建一个 root.component.tsx 文件</p><pre lang="Tsx" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComopnent, ContentType, Injector }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ ComponentLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/browser'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 根组件</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;rootComonent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'RootComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>() {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>() {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">div</span>&gt;这是我的第一个组件&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 根组件加载器</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;rootComponentLoader: ComponentLoader = {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">match</span>() {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;<span class="tb-hl-boolean">true</span></div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">read</span>(element: HTMLElement, context: Injector) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;rootComponent.<span class="tb-hl-function">createInstance</span>(context)</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">Tsx</span></pre>
<p>接下来，我们把根组件和根组件加载器传递给编辑器。</p><pre lang="TypeScript" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Viewer }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/browser'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ rootComponent, rootComponentLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./root.component'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 获取编辑器容器</span></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editorBox = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'editor'</span>)</div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Viewer</span>(rootComponent, rootComponentLoader)</div><div class="tb-code-line"><br></div><div class="tb-code-line">editor.<span class="tb-hl-function">mount</span>(editorBox)</div></div><span class="tb-pre-lang">TypeScript</span></pre>
<p>运行项目，你现在应该可以在浏览器看到根组件的内容渲染到页面了。但当我们尝试去编辑这一段文字的时候，你会发现，这部分内容是不可以编辑器，这是正常的。</p>
<div><strong>在 Textbus 中，任意组件的内容都不可以通过光标去编辑的，要想内容支持编辑，我们需要给组件添加插槽来实现。</strong></div>
<h2>插槽</h2>
<p>插槽表示一段可编辑的文档。就像我们在 div 标签上开启了 contenteditable="true" 一样，我们可以在插槽内添加文字、图片、表格、视频等，也可以给插槽内的文字添加格式。</p>
<p>我们接着修改根组件。</p><pre lang="Tsx" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content tb-color-content-highlight"><div class="tb-code-line-emphasize tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComopnent, ContentType, Injector, useSlots, Slot }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ ComponentLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/browser'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 根组件</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;rootComonent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'RootComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>() {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 添加插槽</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slots =&nbsp;<span class="tb-hl-function">useSlots</span>([</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Slot</span>([</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.Text,</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.BlockComponent,</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.InlineComponent</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>(isOutputMode, slotRenderFn) {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 渲染插槽</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotRenderFn</span>(slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>), () =&gt; {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;&lt;<span class="tb-hl-tag">div</span>/&gt;</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">Tsx</span></pre>
<p>如无意外，刷新页面后，根组件的内容将可以正常输入文字，到这里为止，我们已经基本掌握了组件的基本形态了。</p>
<div><span style="color:rgb(18, 150, 219)"><strong>总结：</strong></span>Textbus 的组件的内容是不可编辑的，要想内容可编辑，我们可以通过给组件添加插槽的方式来实现。</div>
<p style="color:rgb(73, 80, 96)"><span style="background-color:rgb(255, 255, 255)">在当前编辑器中，我们实现了内容可编辑，但只能输入文字，换行和删除文字。但常见的编辑器一般是就一个个段落、列表、表格和视频内容组件的。接下来，我们将在当前基础上，接着开发一个段落组件。</span></p>
<h2 style="color:rgb(73, 80, 96)"><span style="background-color:rgb(255, 255, 255)">段落组件</span></h2>
<p style="color:rgb(73, 80, 96)"><span style="background-color:rgb(255, 255, 255)">新建一个 paragraph.component.tsx 文件。</span></p><pre lang="Tsx" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComopnent, ContentType, Injector, useSlots }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 段落组件</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;paragraphComonent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'ParagrapComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>() {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slots =&nbsp;<span class="tb-hl-function">useSlots</span>([</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.Text,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.InlineComponent</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>(isOutputMode, slotRenderFn) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 渲染插槽</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotRenderFn</span>(slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>), () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;&lt;<span class="tb-hl-tag">p</span>/&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">Tsx</span></pre>
<p>现在，当我们在根组件输入或回车的时候，我们把输入的文字转换为段落。</p><pre lang="TypeScript" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content tb-color-content-highlight"><div class="tb-code-line-emphasize tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComopnent, ContentType, Injector, useSlots, Slot, useContext, Selection }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ ComponentLoader }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/browser'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line-emphasize tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ paragraphComponent }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./paragraph.component'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 根组件</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;rootComonent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'RootComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>() {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 通过 hook 获取上下文</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;injector =&nbsp;<span class="tb-hl-function">useContext</span>()</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selection =&nbsp;<span class="tb-hl-function">useContext</span>(Selection)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 添加插槽</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slots =&nbsp;<span class="tb-hl-function">useSlots</span>([</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Slot</span>([</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.Text,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.InlineComponent</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line"><br></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">onContentInsert</span>(ev =&gt; {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 当输入是字符串或行内组件时，转换为段落</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(<span class="tb-hl-keyword">typeof</span>&nbsp;ev.data.content ===&nbsp;<span class="tb-hl-string">'string'</span>&nbsp;|| ev.data.content.type !== ContentType.BlockComponent) {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;p = paragraphComponent.<span class="tb-hl-function">createInstance</span>(injector)&nbsp;<span class="tb-hl-comment">// 创建段落组件</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slot = p.slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>)!</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slot.<span class="tb-hl-function">insert</span>(ev.data.content)&nbsp;<span class="tb-hl-comment">// 把当前输入的内容插入到段落组件的插槽内</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev.target.<span class="tb-hl-function">insert</span>(p)&nbsp;<span class="tb-hl-comment">// 把段落组件插入到根组件的插槽内</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selection.<span class="tb-hl-function">setPosition</span>(slot, slot.index)&nbsp;<span class="tb-hl-comment">// 设置光标到段落组件的插槽</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev.<span class="tb-hl-function">preventDefault</span>()&nbsp;<span class="tb-hl-comment">// 阻止默认行为</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line-emphasize tb-code-line"><br></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">onBreak</span>((ev) =&gt; {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 当在根组件换行时，转换为段落</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;p = paragraphComponent.<span class="tb-hl-function">createInstance</span>(injector)&nbsp;<span class="tb-hl-comment">// 创建段落组件</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slot = slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>)!</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slot.<span class="tb-hl-function">insert</span>(p)&nbsp;<span class="tb-hl-comment">// 把段落组件插入到根组件的插槽内</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selection.<span class="tb-hl-function">setPosition</span>(p.slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>)!,&nbsp;<span class="tb-hl-number">0</span>)&nbsp;<span class="tb-hl-comment">// 设置光标到段落组件的插槽</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev.<span class="tb-hl-function">preventDefault</span>()&nbsp;<span class="tb-hl-comment">// 阻止默认行为</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>(isOutputMode, slotRenderFn) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 渲染插槽</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotRenderFn</span>(slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>), () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;&lt;div/&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></pre>
<p>现在，我们再次尝试在页面输入，会发现输入的内容转换成了一个段落。但我们的内容，现在又只能输入在段落内，且当敲击回车键时，只会在段落内插入一个换行，而不是新起一个段落。我们再来完成段落换行时，创建一个新段落的功能。</p><pre lang="Tsx" class="tb-pre"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content tb-color-content-highlight"><div class="tb-code-line-emphasize tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComopnent, ContentType, Injector, useContext, useSlots, onBreak, Commander, Selection, useSelf }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 段落组件</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;paragraphComonent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'ParagrapComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponent,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>() {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;self =&nbsp;<span class="tb-hl-function">useSelf</span>()</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;injector =&nbsp;<span class="tb-hl-function">useContext</span>()</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander =&nbsp;<span class="tb-hl-function">useContext</span>(Commander)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;selection =&nbsp;<span class="tb-hl-function">useContext</span>(Selection)</div><div class="tb-code-line-emphasize tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slots =&nbsp;<span class="tb-hl-function">useSlots</span>([</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.Text,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType.InlineComponent</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line"><br></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">onBreak</span>(ev =&gt; {</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 获取当前段落光标后的内容</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;currentSlot = slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>)!</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;delta = currentSlot.<span class="tb-hl-function">cut</span>(ev.data.index).<span class="tb-hl-function">toDelta</span>()</div><div class="tb-code-line-emphasize tb-code-line"><br></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 创建新的段落，并把剪切后的内容插入到新段落的插槽内</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;nextComponent = paragraphComponent.<span class="tb-hl-function">createInstance</span>(injector)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;nextSlot = nextComponent.slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextSlot.<span class="tb-hl-function">insertDelta</span>(delta)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 把新段落插入到当前段落后，并设置光标在新段落的起始位置</span></div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">insertAfter</span>(nextComponent, self)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selection.<span class="tb-hl-function">setPosition</span>(nextSlot,&nbsp;<span class="tb-hl-number">0</span>)</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev.<span class="tb-hl-function">preventDefault</span>()</div><div class="tb-code-line-emphasize tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>(isOutputMode, slotRenderFn) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 渲染插槽</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotRenderFn</span>(slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>), () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;&lt;<span class="tb-hl-tag">p</span>/&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">Tsx</span></pre>
<p>至此，我们完成了一个支持段落的基础编辑器，在下一节，我们将继续在当前的基础上，开发新的组件，并详细了解组件的状态管理相关的功能。</p>
<p style="text-align:center">下<em>一</em>节：<a target="_self" href="https://textbus.io/docs/component">组件</a></p>
  </div>
</template>

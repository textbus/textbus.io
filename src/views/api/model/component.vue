<script setup lang="ts">
import { useDocUpdate } from '@/hooks/use-doc-update';
import { ref } from 'vue';

const doc = ref<HTMLElement>()
useDocUpdate(doc)
</script>
<template>
  <div ref="doc">
    <h1>组件</h1>
<p>什么是 Textbus 的组件？</p>
<p>我们应当都使用过现代前端框架，如 React、Vue、Angular 等，如果你有使用过，那么你会在轻松的上手。如果你没用使用过前端的框架，也没关系，只要阅读下面的文档，你一样可以快速开发出来。&nbsp;</p>
<p>组件带给我们良好的封装、丰富的功能、易于维护和扩展的开发体验。使用 Textbus 开发富文本组件，也可以像前端框架一样，只需要掌握少量的 API 以及生命周期等，即可开发出令人惊叹的富文本组件。当然，Textbus 的组件也有自己的特有的功能，如自动记录操作历史，支持插槽编辑等，不过，你基本无需关心这些，因为 Textbus 的内核已经帮你做好了。</p>
<p>要创建 Textbus 的组件，只需要调用&nbsp;<code>defineComponent</code>&nbsp;函数，并编写特定的配置项即可。 一个简单的组件如下：</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ defineComponent, ContentType, useSlots, Slot, VElement }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;myComponent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.InlineComponent,&nbsp;<span class="tb-hl-comment">// 设置组件类型</span></div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'MyComponent'</span>, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 组件的名字，不可重复</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// data 为组件的状态和插槽的数据</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>(data) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>() {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VElement.<span class="tb-hl-function">createElement</span>(<span class="tb-hl-string">'my-component'</span>,&nbsp;<span class="tb-hl-keyword">null</span>, [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VElement.<span class="tb-hl-function">createElement</span>(<span class="tb-hl-string">'span'</span>,&nbsp;<span class="tb-hl-keyword">null</span>, [<span class="tb-hl-string">'这是我的第一个组件'</span>])</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>Textbus 组件支持用 jsx 或 tsx 编写，也可以用&nbsp;<code>new VElement('p')</code>&nbsp;或者&nbsp;<code>new VTextNode('text')</code>&nbsp;的方式编写。</p>
<h2>组件选项</h2>
<p>上面的示例是一个最简单的组件，但它基本包含了 Textbus 组件的基本形态，更复杂的组件，无非是在这个基础上增加更多的逻辑而已。在开发组件之前，我们需要先理解示例中的几个配置项。</p>
<h3>type</h3>
<p>组件类型。在 Textbus 的数据定义中，共有三种数据类型，它们分别是：</p>
<ul>
  <li class="tb-list-item"><strong>块组件</strong>：ContentType.BlockComponent</li>
  <li class="tb-list-item"><strong>行内组件</strong>：Component.InlineComponent</li>
  <li class="tb-list-item"><strong>文本</strong>：ContentType.Text</li>
</ul>
<p>需要注意的是，这里定义的块组件和行内组件，在展示上并不总是和 HTML 是一样的，它只是 Textbus 用于计算格式变换和结构变换的依据。事实上，你完全可以定义一个块组件，但让它显示效果像一个行内组件，亦或是相反。不过，我们还是建议你在定义组件类型的时候，尽量和展示效果保持一致。</p>
<h3>name</h3>
<p>组件的名字，在一个 Textbus 实例中，它<strong style="color:rgb(231, 79, 94)">必须是唯一</strong>的。Textbus 在查找和储存历史记录时，都会用到它。</p>
<h3>setup()</h3>
<p>组件的核心方法。你可以在该方法内定义组件的行为、数据和渲染函数。一个 Textbus 必须要返回一个含有 render() 方法的对象。其中，render 方法返回的是组件的虚拟 DOM。</p>
<h2>组件加载器</h2>
<p>在上面的文档中，我们已经知道，我们的组件可以用一个 JSON 表示，这当然很美好，但普通用户可能更需要一个直接编辑 HTML 的编辑器。并且，在浏览器中，我们的复制、粘贴行为，也只能是 HTML，所以，我们还需要创建一个组件加载器，才可以让我们的组件在浏览器中正常运行。</p>
<p>我们还是以上面的组件为例：</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;myComponentLoader = {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 匹配一个 DOM 元素是否为 myComponent</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">match</span>(element) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;element.tagName.<span class="tb-hl-function">toLowerCase</span>() ===&nbsp;<span class="tb-hl-string">'my-component'</span></div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 如果匹配成功，则调用 read 方法，我们可以在这里创建组件的实例并返回</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">read</span>(element, injector) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;myComponent.<span class="tb-hl-function">createInstance</span>(injector)</div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 把组件和加载器绑定在一起</span></div><div class="tb-code-line">&nbsp;&nbsp;component: myComponent</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<h3>match()</h3>
<p>用于匹配一个 DOM 元素是否是我们定义的组件，在 myComponentLoader 内，我们用标签名判断。我们也完全可以用元素的属性、className 等来作为判断条件。这根据你定义的组件的不同而不同。</p>
<h3>read()</h3>
<p>当 match 方法返回 true 时，则会调用 read 方法来读取组件的具体内容。由于 myComponent 组件不需要读取任何内容，我们直接返回 myComponent 组件的实例即可。</p>
<p>read 方法会传入三个参数，分别为：</p>
<ul>
  <li class="tb-list-item">element：match 方法匹配到的 DOM 元素</li>
  <li class="tb-list-item">injector：编辑器实例的 IoC 容器</li>
  <li class="tb-list-item">slotParser：一个函数，可以把一个 DOM 元素的内容读取到插槽内。</li>
</ul>
<h3>component</h3>
<p>组件加载器对应的组件。</p>
<h2>使用组件</h2>
<p>现在我们在编辑器中添加我们刚创建的组件。</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Editor }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/editor'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Editor</span>(<span class="tb-hl-string">'#editor'</span>, {</div><div class="tb-code-line">&nbsp;&nbsp;componentLoaders: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;myComponentLoader</div><div class="tb-code-line">&nbsp;&nbsp;]</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>我们还需要添加一个按钮，点击按钮后往文档中插入 MyComponent 组件。</p><pre lang="HTML" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">class</span>="<span class="tb-hl-attr-value">toolbar</span>"&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">insert-my-component</span>"&gt;插入 MyComponent&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">editor</span>"&gt;&lt;/<span class="tb-hl-tag">div</span>&gt;</div></div><span class="tb-pre-lang">HTML</span></div></pre><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Commander, ContentType }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ myComponent }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./my-component'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;insertBtn = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'insert-my-component'</span>)</div><div class="tb-code-line"><br></div><div class="tb-code-line">editor.onReady.<span class="tb-hl-function">subscribe</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander = editor.<span class="tb-hl-function">get</span>(Commander)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;insertBtn.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;componentInstance = myComponent.<span class="tb-hl-function">createInstance</span>(editor)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">insert</span>(componentInstance)</div><div class="tb-code-line">&nbsp;&nbsp;})</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>你也可以在创建编辑器时，把 myComponent 的 HTML 配置在 content 属性中。Textbus 会调用 loader 的来实现组件的实例化。</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Editor</span>(<span class="tb-hl-string">'#editor'</span>, {</div><div class="tb-code-line">&nbsp;&nbsp;componentLoaders: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;myComponentLoader</div><div class="tb-code-line">&nbsp;&nbsp;],</div><div class="tb-code-line">&nbsp;&nbsp;content:&nbsp;<span class="tb-hl-string">'&lt;my-component&gt;&lt;span&gt;这是我的第一个组件&lt;/span&gt;&lt;/my-component&gt;'</span></div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<h2>组件数据结构</h2>
<p>Textbus 的组件完全可以用一个 JSON 来描述。其结构如下：</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-comment">/**</span></div><div class="tb-code-line"><span class="tb-hl-comment">&nbsp;* 组件的 JSON 数据结构</span></div><div class="tb-code-line"><span class="tb-hl-comment">&nbsp;*/</span></div><div class="tb-code-line"><span class="tb-hl-keyword">export</span>&nbsp;<span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">ComponentLiteral</span>&lt;<span class="tb-hl-class-name">State&nbsp;</span>=<span class="tb-hl-class-name">&nbsp;</span><span class="tb-hl-builtin">any</span>&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">/** 组件的名字 */</span></div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-builtin">string</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">/** 组件插槽 JSON 的集合 */</span></div><div class="tb-code-line">&nbsp;&nbsp;slots: SlotLiteral[]</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">/** 组件的状态 */</span></div><div class="tb-code-line">&nbsp;&nbsp;state: State</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>当我们调用一个组件实例的 toJSON 方法时，总是会返回上面的数据结构。当我们创建结构的实例时，如果需要外部提供初始数据，则可以通过组件实例的 createInstance() 方法的第二个参数传入组件。示例如下：</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;slot =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Slot</span>([ContentType.Text])</div><div class="tb-code-line">yourComponent.<span class="tb-hl-function">createInstance</span>(injector, {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 组件插槽的集合</span></div><div class="tb-code-line">&nbsp;&nbsp;slots: [slot],</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// 组件的状态</span></div><div class="tb-code-line">&nbsp;&nbsp;state: {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'张三'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;age:&nbsp;<span class="tb-hl-number">34</span></div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>当我们在创建实例时传入第二个参数，则会在 setup 方法的第一个参数接收到传入的数据。</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;yourComponent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;...</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>(data) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-builtin">console</span>.<span class="tb-hl-function">log</span>(data)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 输出：</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// {</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// &nbsp;&nbsp;slots: [slot],</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// &nbsp;&nbsp;state: {</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// &nbsp;&nbsp;&nbsp;&nbsp;name: '张三',</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// &nbsp;&nbsp;&nbsp;&nbsp;age: 34</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// &nbsp;&nbsp;}</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// }</span></div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<h2>带插槽的组件</h2>
<p>上面的示例中，myComponent 组件只是一段 HTML 的封装，而没有其它任何功能和数据交互。如果你把它插入到文档中，你会发现，你无法用光标去编辑 myComponent 组件的任何内容，而是要么添加，要么删除。这是 Textbus 的组件的特点，在组件内的 DOM 节点和内容，是无法编辑的<span style="font-size:15px;color:rgb(128, 132, 143)">（组件自己的方法可以更改）</span>。</p>
<p>要让组件内的内容可以通过光标编辑，我们需要给组件添加插槽。我们以开发一个可设置风格的警告框为例。</p>
<p>在正式编写组件之前，我们先定义组件的数据模型：</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ SlotLiteral, Slot }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 组件的 JSON 表示</span></div><div class="tb-code-line"><span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">MyComponentState</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;type:&nbsp;<span class="tb-hl-string">'primary'</span>&nbsp;|&nbsp;<span class="tb-hl-string">'success'</span>&nbsp;|&nbsp;<span class="tb-hl-string">'danger'</span>&nbsp;<span class="tb-hl-comment">// 组件的三种风格</span></div><div class="tb-code-line">&nbsp;&nbsp;content: SlotLiteral&nbsp;<span class="tb-hl-comment">// 插槽的 JSON 表示</span></div><div class="tb-code-line">}</div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-comment">// 组件的数据</span></div><div class="tb-code-line"><span class="tb-hl-keyword">interface</span>&nbsp;<span class="tb-hl-class-name">MyComponentData</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;type:&nbsp;<span class="tb-hl-string">'primary'</span>&nbsp;|&nbsp;<span class="tb-hl-string">'success'</span>&nbsp;|&nbsp;<span class="tb-hl-string">'danger'</span>&nbsp;<span class="tb-hl-comment">// 组件的三种风格</span></div><div class="tb-code-line">&nbsp;&nbsp;content: Slot&nbsp;<span class="tb-hl-comment">// 插槽的实例</span></div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>定义好了数据模型，我们就可以真正开始我们的组件编写了。</p><pre lang="Tsx" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ ContentType, useSlots, ContentType, RenderMode }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;alertComponent =&nbsp;<span class="tb-hl-function">defineComponent</span>({</div><div class="tb-code-line">&nbsp;&nbsp;type: ContentType.BlockComponet,</div><div class="tb-code-line">&nbsp;&nbsp;name:&nbsp;<span class="tb-hl-string">'AlertComponent'</span>,</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-comment">// data 在调用 alertComponent.createInstance() 方法第二个参数</span></div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">setup</span>(data) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 把插槽注册 Textbus 数据树中，使用插槽能够被修改</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slots =&nbsp;<span class="tb-hl-function">useSlots</span>(data.slots)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">let</span>&nbsp;state = {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: data.state.<span class="tb-hl-keyword">type</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;stateController =&nbsp;<span class="tb-hl-function">useState</span>(state)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;subscription = stateController.onChange.<span class="tb-hl-function">subscribe</span>(newState =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 监听状态变化，并使用新状态</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state = newState</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">function</span>&nbsp;<span class="tb-hl-function">updateType</span>(type) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stateController.<span class="tb-hl-function">update</span>(draft =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;draft.type =&nbsp;<span class="tb-hl-keyword">type</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">render</span>(slotRender, renderMode) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;(</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">class</span>={<span class="tb-hl-string">'alert '</span>&nbsp;+ state.type}&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 判断是否是编辑模式，如果是，则渲染三个按钮用来设置风格，否则不输出节点</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-comment">// 当虚拟 DOM 节点值为 false 时，会被忽略</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderMode !== RenderMode.Editing ?</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-boolean">false</span>&nbsp;:</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&lt;<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">onClick</span>={() =&gt;&nbsp;<span class="tb-hl-function">updateType</span>(<span class="tb-hl-string">'primary'</span>)}&gt;设置为 Primary&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">onClick</span>={() =&gt;&nbsp;<span class="tb-hl-function">updateType</span>(<span class="tb-hl-string">'success'</span>)}&gt;设置为 Success&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">onClick</span>={() =&gt;&nbsp;<span class="tb-hl-function">updateType</span>(<span class="tb-hl-string">'danger'</span>)}&gt;设置为 Danger&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/<span class="tb-hl-tag">div</span>&gt;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotRender</span>(slots.<span class="tb-hl-function">get</span>(<span class="tb-hl-number">0</span>), children =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">class</span>="<span class="tb-hl-attr-value">alert-content</span>"&gt;{children}&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">Tsx</span></div></pre>
<p>编写组件加载器。</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;alertComponentLoader = {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">match</span>(element) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;element.tagName ===&nbsp;<span class="tb-hl-string">'div'</span>&nbsp;&amp;&amp; element.classList.<span class="tb-hl-function">contains</span>(<span class="tb-hl-string">'alert'</span>)</div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-function">read</span>(element, injector, slotParser) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;type =&nbsp;<span class="tb-hl-string">''</span>;</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(element.classList.<span class="tb-hl-function">contains</span>(<span class="tb-hl-string">'primary'</span>)) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&nbsp;<span class="tb-hl-string">'primary'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="tb-hl-keyword">else</span>&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(element.classList.<span class="tb-hl-function">contains</span>(<span class="tb-hl-string">'success'</span>)) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&nbsp;<span class="tb-hl-string">'success'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="tb-hl-keyword">else</span>&nbsp;<span class="tb-hl-keyword">if</span>&nbsp;(element.classList.<span class="tb-hl-function">contains</span>(<span class="tb-hl-string">'danger'</span>)) {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&nbsp;<span class="tb-hl-string">'danger'</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;slot =&nbsp;<span class="tb-hl-keyword">new</span>&nbsp;<span class="tb-hl-class-name">Slot</span>([ContentType.Text])</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-function">slotParser</span>(slot, element.children[<span class="tb-hl-number">1</span>])</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">return</span>&nbsp;alertComponent.<span class="tb-hl-function">createInstance</span>(injector, {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state: {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type:&nbsp;<span class="tb-hl-keyword">type</span></div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slots: [slot]</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;},</div><div class="tb-code-line">&nbsp;&nbsp;component: alertComponent</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p>现在，我们把 alertComponentLoader 添加到编辑器中。</p><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;editor =&nbsp;<span class="tb-hl-function">createEditor</span>(<span class="tb-hl-string">'#editor'</span>, {</div><div class="tb-code-line">&nbsp;&nbsp;componentLoaders: [</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;myComponentLoader,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;alertComponentLoader</div><div class="tb-code-line">&nbsp;&nbsp;]</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<h3>应用新组件</h3>
<p>添加一个按钮，点击时插入一个新的 alertComponent 组件到文档内。</p><pre lang="HTML" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">class</span>="<span class="tb-hl-attr-value">toolbar</span>"&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">insert-my-component</span>"&gt;插入 MyComponent&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&nbsp;&nbsp;&lt;<span class="tb-hl-tag">button&nbsp;</span><span class="tb-hl-attr-name">type</span>="<span class="tb-hl-attr-value">button</span>"<span class="tb-hl-tag">&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">insert-alert-component</span>"&gt;插入 AlertComponent&lt;/<span class="tb-hl-tag">button</span>&gt;</div><div class="tb-code-line">&lt;/<span class="tb-hl-tag">div</span>&gt;</div><div class="tb-code-line">&lt;<span class="tb-hl-tag">div&nbsp;</span><span class="tb-hl-attr-name">id</span>="<span class="tb-hl-attr-value">editor</span>"&gt;&lt;/<span class="tb-hl-tag">div</span>&gt;</div></div><span class="tb-pre-lang">HTML</span></div></pre><pre lang="TypeScript" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ Commander, ContentType }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'@textbus/core'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ myComponent }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./my-component'</span></div><div class="tb-code-line"><span class="tb-hl-keyword">import</span>&nbsp;{ alertComponent }&nbsp;<span class="tb-hl-keyword">from</span>&nbsp;<span class="tb-hl-string">'./alert-component'</span></div><div class="tb-code-line"><br></div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;insertBtn = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'insert-my-component'</span>)</div><div class="tb-code-line"><span class="tb-hl-keyword">const</span>&nbsp;insertBtn2 = document.<span class="tb-hl-function">getElementById</span>(<span class="tb-hl-string">'insert-alert-component'</span>)</div><div class="tb-code-line"><br></div><div class="tb-code-line">editor.onReady.<span class="tb-hl-function">subscribe</span>(() =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;commander = editor.<span class="tb-hl-function">get</span>(Commander)</div><div class="tb-code-line"><br></div><div class="tb-code-line">&nbsp;&nbsp;insertBtn.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;componentInstance = myComponent.<span class="tb-hl-function">createInstance</span>(editor)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">insert</span>(componentInstance)</div><div class="tb-code-line">&nbsp;&nbsp;})</div><div class="tb-code-line">&nbsp;&nbsp;insertBtn2.<span class="tb-hl-function">addEventListener</span>(<span class="tb-hl-string">'click'</span>, () =&gt; {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-keyword">const</span>&nbsp;componentInstance = alertComponent.<span class="tb-hl-function">createInstance</span>(editor)</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;commander.<span class="tb-hl-function">insert</span>(componentInstance)</div><div class="tb-code-line">&nbsp;&nbsp;})</div><div class="tb-code-line">})</div></div><span class="tb-pre-lang">TypeScript</span></div></pre>
<p><strong style="color:rgb(231, 79, 94)">一个组件可以没有插槽，也可以有任意个插槽，你可以根据自己的需要定制。</strong></p>
<h2>TSX/JSX 配置</h2>
<p>使用命令式编写组件的虚拟 DOM 无疑是一个比较麻烦和容易出错的方式，在 Textbus 中，我们可以使用 jsx / tsx 编写 Textbus 组件，前提是你需要配置相应环境才可以正确编译。</p>
<p>在上面的示例中，我们看到了使用 VElement.createElement 的方式创建虚拟 DOM，这和 React 的工厂方法是类似的。有了这个基础，我们就可以通过 tsx 的方式来编写组件了。</p>
<p>要用 tsx 编写组件首先要在项目中的 tsconfig.json 中添加如下声明：</p><pre lang="JSON" theme="dark" class="tb-pre"><div class="tb-pre-content"><div style="width:2.5em" class="tb-code-line-number-bg"></div><div class="tb-code-content"><div class="tb-code-line">{</div><div class="tb-code-line">&nbsp;&nbsp;<span class="tb-hl-attr-name">"compilerOptions"</span>: {</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-attr-name">"jsx"</span>:&nbsp;<span class="tb-hl-string">"react"</span>,</div><div class="tb-code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tb-hl-attr-name">"jsxFactory"</span>:&nbsp;<span class="tb-hl-string">"VElement.createElement"</span></div><div class="tb-code-line">&nbsp;&nbsp;}</div><div class="tb-code-line">}</div></div><span class="tb-pre-lang">JSON</span></div></pre>
<p>以上配置适用于在整个项目只有一种 tsx 类型的情况，如果在 Vue/React 项目中，以上声明会导致 Textbus 的虚拟 DOM 工厂函数和 Vue/React 的虚拟 DOM 工厂函数发生冲突。同时，Vue cli 的 ts 项目的编译方式和 React 项目的编辑方式还有所不同，我们需要分别处理。</p>
<p>如果你不想使用 TypeScript，而是用 JavaScript &nbsp;开发，你还可以用 babel 来转换 jsx，babel 自定义 jsx 工厂函数的方法，请使用搜索引擎或 babel 官网查看相关文档。</p>
<h3>React 项目配置</h3>
<p>本仓库演示了在 React 项目内，同时使用两种 jsx 工厂函数的项目配置，仅作为参考。</p>
<p><a target="_blank" href="https://github.com/textbus/react-demo">https://github.com/textbus/react-demo</a></p>
<h3>Vue 项目配置</h3>
<p>本仓库演示了在 Vue 项目内，同时使用两种 jsx 工厂函数的项目配置，仅作为参考。</p>
<p><a target="_blank" href="https://github.com/textbus/vue-demo">https://github.com/textbus/vue-demo</a></p>
  </div>
</template>